var fs = require('fs');
var getHomedir = require('./homedir');
var path = require('path');
var caller = require('./caller');
var nodeModulesPaths = require('./node-modules-paths');
var normalizeOptions = require('./normalize-options');
var isCore = require('is-core-module');

var realpathFS = process.platform !== 'win32' && fs.realpath && typeof fs.realpath.native === 'function' ? fs.realpath.native : fs.realpath;

var homedir = getHomedir();
var defaultPaths = function () {
    return [
        path.join(homedir, '.node_modules'),
        path.join(homedir, '.node_libraries')
    ];
};

var defaultIsFile = function isFile(file, cb) {
    fs.stat(file, function (err, stat) {
        if (!err) {
            return cb(null, stat.isFile() || stat.isFIFO());
        }
        if (err.code === 'ENOENT' || err.code === 'ENOTDIR') return cb(null, false);
        return cb(err);
    });
};

var defaultIsDir = function isDirectory(dir, cb) {
    fs.stat(dir, function (err, stat) {
        if (!err) {
            return cb(null, stat.isDirectory());
        }
        if (err.code === 'ENOENT' || err.code === 'ENOTDIR') return cb(null, false);
        return cb(err);
    });
};

var defaultRealpath = function realpath(x, cb) {
    realpathFS(x, function (realpathErr, realPath) {
        if (realpathErr && realpathErr.code !== 'ENOENT') cb(realpathErr);
        else cb(null, realpathErr ? x : realPath);
    });
};

var maybeRealpath = function maybeRealpath(realpath, x, opts, cb) {
    if (opts && opts.preserveSymlinks === false) {
        realpath(x, cb);
    } else {
        cb(null, x);
    }
};

var defaultReadPackage = function defaultReadPackage(readFile, pkgfile, cb) {
    readFile(pkgfile, function (readFileErr, body) {
        if (readFileErr) cb(readFileErr);
        else {
            try {
                var pkg = JSON.parse(body);
                cb(null, pkg);
            } catch (jsonErr) {
                cb(null);
            }
        }
    });
};

var getPackageCandidates = function getPackageCandidates(x, start, opts) {
    var dirs = nodeModulesPaths(start, opts, x);
    for (var i = 0; i < dirs.length; i++) {
        dirs[i] = path.join(dirs[i], x);
    }
    return dirs;
};

module.exports = function resolve(x, options, callback) {
    var cb = callback;
    var opts = options;
    if (typeof options === 'function') {
        cb = opts;
        opts = {};
    }
    if (typeof x !== 'string') {
        var err = new TypeError('Path must be a string.');
        return process.nextTick(function () {
            cb(err);
        });
    }

    opts = normalizeOptions(x, opts);

    var isFile = opts.isFile || defaultIsFile;
    var isDirectory = opts.isDirectory || defaultIsDir;
    var readFile = opts.readFile || fs.readFile;
    var realpath = opts.realpath || defaultRealpath;
    var readPackage = opts.readPackage || defaultReadPackage;
    if (opts.readFile && opts.readPackage) {
        var conflictErr = new TypeError('`readFile` and `readPackage` are mutually exclusive.');
        return process.nextTick(function () {
            cb(conflictErr);
        });
    }
    var packageIterator = opts.packageIterator;

    var extensions = opts.extensions || ['.js'];
    var includeCoreModules = opts.includeCoreModules !== false;
    var basedir = opts.basedir || path.dirname(caller());
    var parent = opts.filename || basedir;

    opts.paths = opts.paths || defaultPaths();

    // ensure that `basedir` is an absolute path at this point, resolving against the process' current working directory
    var absoluteStart = path.resolve(basedir);

    maybeRealpath(
        realpath,
        absoluteStart,
        opts,
        function (err, realStart) {
            if (err) cb(err);
            else init(realStart);
        }
    );

    var res;
    function init(basedir) {
        if ((/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/).test(x)) {
            res = path.resolve(basedir, x);
            if (x === '.' || x === '..' || x.slice(-1) === '/') res += '/';
            if ((/\/$/).test(x) && res === basedir) {
                loadAsDirectory(res, opts.package, onfile);
            } else loadAsFile(res, opts.package, onfile);
        } else if (includeCoreModules && isCore(x)) {
            return cb(null, x);
        } else loadNodeModules(x, basedir, function (err, n, pkg) {
            if (err) cb(err);
            else if (n) {
                return maybeRealpath(realpath, n, opts, function (err, realN) {
                    if (err) {
                        cb(err);
                    } else {
                        cb(null, realN, pkg);
                    }
                });
            } else {
                var moduleError = new Error("Cannot find module '" + x + "' from '" + parent + "'");
                moduleError.code = 'MODULE_NOT_FOUND';
                cb(moduleError);
            }
        });
    }

    function onfile(err, m, pkg) {
        if (err) cb(err);
        else if (m) cb(null, m, pkg);
        else loadAsDirectory(res, function (err, d, pkg) {
            if (err) cb(err);
            else if (d) {
                maybeRealpath(realpath, d, opts, function (err, realD) {
                    if (err) {
                        cb(err);
                    } else {
                        cb(null, realD, pkg);
                    }
                });
            } else {
                var moduleError = new Error("Cannot find module '" + x + "' from '" + parent + "'");
                moduleError.code = 'MODULE_NOT_FOUND';
                cb(moduleError);
            }
        });
    }

    function loadAsFile(x, thePackage, callback) {
        var loadAsFilePackage = thePackage;
        var cb = callback;
        if (typeof loadAsFilePackage === 'function') {
            cb = loadAsFilePackage;
            loadAsFilePackage = undefined;
        }

        var exts = [''].concat(extensions);
        load(exts, x, loadAsFilePackage);

        function load(exts, x, loadPackage) {
            if (exts.length === 0) return cb(null, undefined, loadPackage);
            var file = x + exts[0];

            var pkg = loadPackage;
            if (pkg) onpkg(null, pkg);
            else loadpkg(path.dirname(file), onpkg);

            function onpkg(err, pkg_, dir) {
                pkg = pkg_;
                if (err) return cb(err);
                if (dir && pkg && opts.pathFilter) {
                    var rfile = path.relative(dir, file);
                    var rel = rfile.slice(0, rfile.length - exts[0].length);
                    var r = opts.pathFilter(pkg, x, rel);
                    if (r) return load(
                        [''].concat(extensions.slice()),
                        path.resolve(dir, r),
                        pkg
                    );
                }
                isFile(file, onex);
            }
            function onex(err, ex) {
                if (err) return cb(err);
                if (ex) return cb(null, file, pkg);
                load(exts.slice(1), x, pkg);
            }
        }
    }

    function loadpkg(dir, cb) {
        if (dir === '' || dir === '/') return cb(null);
        if (process.platform === 'win32' && (/^\w:[/\\]*$/).test(dir)) {
            return cb(null);
        }
        if ((/[/\\]node_modules[/\\]*$/).test(dir)) return cb(null);

        maybeRealpath(realpath, dir, opts, function (unwrapErr, pkgdir) {
            if (unwrapErr) return loadpkg(path.dirname(dir), cb);
            var pkgfile = path.join(pkgdir, 'package.json');
            isFile(pkgfile, function (err, ex) {
                // on err, ex is false
                if (!ex) return loadpkg(path.dirname(dir), cb);

                readPackage(readFile, pkgfile, function (err, pkgParam) {
                    if (err) cb(err);

                    var pkg = pkgParam;

                    if (pkg && opts.packageFilter) {
                        pkg = opts.packageFilter(pkg, pkgfile);
                    }
                    cb(null, pkg, dir);
                });
            });
        });
    }

    function loadAsDirectory(x, loadAsDirectoryPackage, callback) {
        v  D  H‹ÃH‹\$`HƒÄP_ÃÌÌÌÌÌÌÌH‰\$D‰L$ UVWATAUAVAWH‹ìHì€   H‹µ   3Û3ÀH‰]Ø‰]@WÀH‰]ĞD‹âH‰]à‹ùD‹éD‹óD‹ûH‰FAƒøuÇÿ  A¿   ç şÿÿëAƒø¸   DDğ3ÉHÿ[È  D  Aº   ƒøu	AƒüuEú‹…ˆ   ƒètA¹  àƒøtA¹  àH‹E`A‹ÏH‹UhHÿ  H% ğÿÿHâ ğÿÿö]xH‰EèÀH‰UğƒàÿÀD‹ÀAƒÈ8€   DDÀ‹EpD‰D$@ºé‰D$8LEØI;ÒHEèH‰D$0ACÏD‰t$(‰L$ HMĞ‹×Hÿ“É  D  ‹ø…Àˆµ   3ÉHÿ“Ç  D  ƒøu'H‹MĞLE@HUàHÿ>É  D  ‹ø…Àˆ€   ‹E@ë‹EØ‰E@L‹µ˜   M…öt?ƒ}XH   H‹UĞD‹ËD‹ÀA”ÁIÁàHÿÜÆ  D  ‹ø…Àx:H‹…   I‰H‰‹E@D;èABÅ3É‰FHÿşÆ  D  H‹MĞƒøHDMàH‰NëH‹MĞH…ÉtHÿ¿Æ  D  ÿ»  Àu¸'   ë…ÿy‹ßH¸       €HØH‹ÃH‹œ$È   HÄ€   A_A^A]A\_^]ÃÌÌÌÌÌÌÌÌÌÌH‰\$H‰l$D‰L$ VWAVHƒì`H‹ÙA‹è3ÉD‹òHÿ_Æ  D  ƒøt
¸   éÚ   H‹¼$    HL$@H‰\$@WÀ3Û3À‰\$0H‹ÕH‰\$(A¹   A¸  àH‰G‰\$ HÿØÇ  D  ‹È…ÀuvH‹L$@L„$˜   HT$PHÿ¬Ç  D  ‹È…ÀxVH‹´$¨   H…öt9H‹T$@HL$HD‹ËD‹ÅAƒşA”ÁAÁàHÿYÅ  D  ‹È…ÀxH‹D$HH‰H‰H‹D$PH‰G‰o…Éy‹ÙH¸       €HØH‹ÃL\$`I‹[ I‹k(I‹ãA^_^ÃÌÌÌÌÌÌÌÌH‰\$WHƒì 3ÿH‹ÙH99t‹QH‹	ÁâHÿ Å  D  @8{t=H‹KH…Ét^9{v!H‹K‹ÇH‹ÁHÿîÄ  D  ÿÇ;{rãH‹KHÿÏÅ  D  ë*3ÉHÿßÄ  D  H‹KƒøuH‹	HÁáHÿ«Ä  D  WÀ3ÀH‰CH‹\$0HƒÄ _ÃÌÌÌÌÌÌÌH‰\$H‰l$H‰t$WHƒì ‹òA‹ØH‹éE…Àu‹Y‹û3É+şHÿoÄ  D  ƒøuF…ÿtBL‹EHÿ‹ÑM‹ğÿÆ;ós<+ŞMğD‹ÓIAI; uú   uÿÁ3ÒM‹ÿÂIƒÀIƒêuÜë‹ÏHÁÿÿÿ HÁéH‹\$0‹ÁH‹l$8H‹t$@HƒÄ _ÃÌÌÌÌÌÌÌH‰\$H‰l$H‰t$WAVAWHƒì 3Û‹êM‹ùA‹ğL‹ñE…Àu‹q‹ş3É+ıHÿºÃ  D  ƒø…‘   …ÿ„‰   I‹NUDHÿL‹éH½ÿÿÿÿÿ   I‹ø;ÖsSD‹ÒA»   IÁâ+òHGI;
u
E;ËtAÿÁë"L#ÅAIÿHÁá(A¹   IÈI‰ßÿÃI‹NM‹
I‹<
IƒÂHƒîu¼L#ÅAIÿHÁá(IÈI‰ßÿÃëKM‹VIÁêLÕ…ÿt<H½ÿÿÿÿÿ   A»   A;ûI‹ÊE‹ËDBÏH#ÍAQÿHÁâ(HÑA‹ÉI‰ßLÑÿÃA+ùuÔH‹l$H‹ÃH‹\$@H‹t$PHƒÄ A_A^_ÃÌÌÌÌÌÌÌÌÌH‹ÄH‰XH‰hH‰HVWAVHƒì E3öI‹øH‹êL‰pA‹öM9pu9»  ‹ËHÿáÂ  D  H…Àu
¸  Àéó   L‹ÃÇ  3ÒH‰GH‹Èè7°  HÎ  A¸   H‹ËH7Ê  HÿÄ  D  …ÀuTH5nÎ  HÿqÂ  D  LD$@º  "H‹HHÿçÂ  D  ‹Ø…ÀxjH‹\$@HƒÈÿHÿÀfD94Cuöfƒ|Cş\ufD‰tCşH‹ÓH‹ÏHÿÂ  D  ‹Ø…Àx1H…ötH‹ÖH‹ÏHÿñÁ  D  ‹Ø…ÀxH‹ÕH‹ÏHÿÙÁ  D  ‹ØH‹L$@H…ÉtHÿQÂ  D  ‹ÃH‹\$HH‹l$PHƒÄ A^_^ÃÌÌÌÌÌÌÌH‹ÄH‰PL‰@L‰H Hì(  L‹ÂLHºÿ  HL$ HÿšÂ  D  …Àx
H˜H=ÿ  rÆ„$   HT$ HÉ  HÿìÂ  D  HÄ(  ÃÌÌÌÌÌÌÌH‰\$WHƒì H‹|$PWÀAI‹ÙH‹ÑA¹   H‹ÏEA?Hÿ`À  D  3É…ÀxH‹H‰HÇC@   ë‹ÈH¸       €HÈH‹\$0H‹ÁHƒÄ _ÃÌÌÌÌÌÌÌÌH‹ÄH‰XH‰pWHƒì`I‹ğ3ÛL@Ø‰XØH‹ÑH‰Xàèœıÿÿ‹ø…ÀxWH‹T$HHN»  ‹Hõ E3ÉH‰D$PL‹ÆHD$PH‰\$0H‰D$(‰\$ ‰\$XHÿŸÁ  D  ¹   €‹øÁ…Áuÿ5  Àu‹ûHL$@HÿOÁ  D  …ÿy‹ßH¸       €HØH‹t$xH‹ÃH‹\$pHƒÄ`_ÃÌÌÌÌÌÌÌÌH‹ÄH‰XH‰hH‰pWHì    I‹ğ3ÛL@Ø‰XØH‹ÑH‰XàI‹éèÎüÿÿ‹ø…ÀˆÄ   ‹¼$Ø   @öÇt3Ò¹  HÿÍ¿  D  H‹”$ˆ   ‹ÇH‰\$xƒàş‹ÏL‹ÆƒáDÇ÷Ù‰„$˜   HŒ$   H‰L$pH.º  ‹(ô H‰„$   ÀƒàE3ÉƒÀ‰D$hH‹„$Ğ   ‰\$`‰\$X‰\$P‰\$HH‰\$@H‰D$8H‰l$0ÇD$( @ ÇD$   àHÿkÀ  D  ‹ø…Àx‹ûë"L‹Îÿ( ÀuH‚Á  èíÿÿë	‰|$ èbíÿÿHŒ$€   Hÿë¿  D  …ÿy‹ßH¸       €HØLœ$    H‹ÃI‹[I‹kI‹s I‹ã_ÃÌÌÌÌÌÌÌH‰\$H‰l$H‰t$WHƒì0½   I‹ø‹ÍH‹òHÿˆ¾  D  H‹ØH…ÀuH¸š  À   €é™   L‹Å3ÒH‹Ëèà«  ½€   LÆ  ‹ÕH‹ËHÿW¿  D  ƒ=Óğ EuW‹àğ …ÉuDM‚D8yñ u@·ìğ LáÅ  ë;Èu,·¸ğ LõÅ  A¹€  H‹Õ‰D$ H‹ËHÿF¾  D  2ÀH‰H…ÿtˆ3ÀH‹\$@H‹l$HH‹t$PHƒÄ0_ÃÌÌÌÌÌÌÌÌÌÌM…Éu¸  ÀÃÌA‹ƒÈA‰öÁup‚  A‰öÁtºèA‰3ÀÃÌÌÌÌÌÌÌL‹Â¹   2HÁâ HÂHºà
s¹  2HÁâ HÂëH‹ñ ‹@ ÁèA‰ ÃÌÌÌÌÌÌÌ@SHƒì ‹Ù3ÉHÿ»¼  D  ƒøt4¹   2HÁâ HÂHºà
s¹  2HÁâ HÂë7H‹5ñ ‹@ Áèë(LD$